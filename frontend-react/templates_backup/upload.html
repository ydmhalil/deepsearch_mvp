{% extends "base.html" %}

{% block custom_styles %}
<style>
/* Upload-specific styles with unified design system */
.upload-hero {
    background: var(--gradient-primary);
    padding: 3rem 0;
    color: white;
    text-align: center;
    margin-bottom: 2rem;
}

.upload-hero h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: var(--card-background);
    padding: 1.5rem;
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-medium);
    text-align: center;
    border: 1px solid var(--border-color);
    transition: var(--transition-smooth);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-large);
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
    display: block;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-weight: 500;
}

.upload-section {
    background: var(--card-background);
    padding: 2rem;
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-medium);
    margin-bottom: 2rem;
    border: 1px solid var(--border-color);
}

.drag-drop-area {
    border: 3px dashed var(--primary-color);
    border-radius: var(--border-radius-lg);
    padding: 3rem 2rem;
    text-align: center;
    background: var(--primary-light);
    transition: var(--transition-smooth);
    cursor: pointer;
    position: relative;
}

.drag-drop-area:hover {
    border-color: var(--primary-dark);
    background: var(--primary-lighter);
    transform: translateY(-2px);
}

.drag-drop-area.dragover {
    border-color: var(--success-color);
    background: var(--success-light);
}

.upload-icon {
    font-size: 3rem;
    color: var(--primary-color);
    margin-bottom: 1rem;
    display: block;
}

.upload-text {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.upload-hint {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
}

.file-types {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-top: 1rem;
}

.file-list {
    max-height: 400px;
    overflow-y: auto;
}

.file-item-unified {
    background: var(--card-background);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-md);
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: var(--transition-smooth);
}

.file-item-unified:hover {
    border-color: var(--primary-color);
    transform: translateY(-1px);
    box-shadow: var(--shadow-medium);
}

.file-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.file-icon {
    width: 40px;
    height: 40px;
    background: var(--primary-light);
    border-radius: var(--border-radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-color);
    font-size: 1.2rem;
}

.file-details h6 {
    margin: 0;
    color: var(--text-primary);
    font-weight: 600;
}

.file-meta {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin: 0.25rem 0;
}

.file-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.progress-unified {
    height: 8px;
    background: var(--background-light);
    border-radius: var(--border-radius-sm);
    overflow: hidden;
    margin-top: 1rem;
}

.progress-bar-unified {
    height: 100%;
    background: var(--gradient-primary);
    transition: width 0.3s ease;
    border-radius: var(--border-radius-sm);
}

.upload-progress {
    background: var(--card-background);
    padding: 1.5rem;
    border-radius: var(--border-radius-lg);
    margin-top: 1.5rem;
    border: 1px solid var(--border-color);
}

.progress-item {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding: 0.75rem;
    background: var(--background-light);
    border-radius: var(--border-radius-md);
}

.progress-item:last-child {
    margin-bottom: 0;
}

.sidebar-section {
    background: var(--card-background);
    padding: 1.5rem;
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-medium);
    border: 1px solid var(--border-color);
}

.distribution-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border-color);
}

.distribution-item:last-child {
    border-bottom: none;
}

.file-type-badge {
    background: var(--primary-light);
    color: var(--primary-color);
    padding: 0.25rem 0.75rem;
    border-radius: var(--border-radius-sm);
    font-size: 0.8rem;
    font-weight: 600;
}

@media (max-width: 768px) {
    .upload-hero h1 {
        font-size: 2rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    .drag-drop-area {
        padding: 2rem 1rem;
    }
    
    .file-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .file-actions {
        width: 100%;
        justify-content: flex-start;
    }
}
</style>
{% endblock %}

{% block content %}

<!-- Hero Section -->
<div class="upload-hero">
    <div class="container">
        <h1><i class="bi bi-cloud-upload"></i> Dosya Yükleme</h1>
        <p class="lead">Belgelerinizi sisteme yükleyerek arama ve analiz yapabilirsiniz</p>
    </div>
</div>

<div class="container">
    <!-- Upload Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-value">{{ upload_stats.total_files }}</span>
            <span class="stat-label">Toplam Dosya</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">{{ upload_stats.indexed_files }}</span>
            <span class="stat-label">İndekslenmiş</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">{{ upload_stats.pending_files }}</span>
            <span class="stat-label">Bekleyen</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">{{ upload_stats.total_size_mb }} MB</span>
            <span class="stat-label">Toplam Boyut</span>
        </div>
    </div>

    <!-- Upload Area -->
    <div class="row">
        <div class="col-lg-8">
            <div class="upload-section">
                <h3><i class="bi bi-folder-plus"></i> Yeni Dosya Yükle</h3>
                
                <div class="drag-drop-area" id="dragDropArea">
                    <i class="bi bi-cloud-upload upload-icon"></i>
                    <div class="upload-text">Dosyaları sürükleyip bırakın</div>
                    <div class="upload-hint">veya dosya seçmek için tıklayın</div>
                    <input type="file" id="fileInput" multiple accept=".pdf,.docx,.xlsx,.pptx,.txt" style="display: none;">
                    <button type="button" class="btn btn-unified" onclick="document.getElementById('fileInput').click()">
                        <i class="bi bi-plus-circle me-2"></i>Dosya Seç
                    </button>
                    <div class="file-types">
                        Desteklenen formatlar: PDF, DOCX, XLSX, PPTX, TXT (Max: 50MB)
                    </div>
                </div>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" style="display: none;" class="upload-progress">
                    <h5><i class="bi bi-clock-history"></i> Yükleme Durumu</h5>
                    <div id="progressList"></div>
                </div>
            </div>
        </div>
        
        <!-- File Type Distribution -->
        <div class="col-lg-4">
            <div class="sidebar-section">
                <h5><i class="bi bi-pie-chart"></i> Dosya Türleri</h5>
                <div class="distribution-list">
                    {% for file_type, count in upload_stats.files_by_type.items() %}
                    <div class="distribution-item">
                        <span>{{ file_type.upper() }}</span>
                        <span class="file-type-badge">{{ count }}</span>
                    </div>
                    {% endfor %}
                    {% if not upload_stats.files_by_type %}
                    <p class="text-muted text-center">Henüz dosya yüklenmemiş</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Uploaded Files List -->
{% if uploaded_files %}
<div class="container mt-4">
    <div class="upload-section">
        <h3><i class="bi bi-files"></i> Yüklenmiş Dosyalar</h3>
        <div class="file-list">
            {% for file in uploaded_files %}
            <div class="file-item-unified">
                <div class="file-info">
                    <div class="file-icon">
                        {% if file.filename.lower().endswith('.pdf') %}
                            <i class="bi bi-file-earmark-pdf"></i>
                        {% elif file.filename.lower().endswith(('.docx', '.doc')) %}
                            <i class="bi bi-file-earmark-word"></i>
                        {% elif file.filename.lower().endswith(('.xlsx', '.xls')) %}
                            <i class="bi bi-file-earmark-excel"></i>
                        {% elif file.filename.lower().endswith(('.pptx', '.ppt')) %}
                            <i class="bi bi-file-earmark-ppt"></i>
                        {% else %}
                            <i class="bi bi-file-earmark-text"></i>
                        {% endif %}
                    </div>
                    <div class="file-details flex-grow-1">
                        <h6>{{ file.filename }}</h6>
                        <div class="file-meta">
                            <span><i class="bi bi-hdd"></i> {{ (file.file_size / 1024 / 1024) | round(2) }} MB</span>
                            <span class="ms-3"><i class="bi bi-calendar"></i> {{ file.upload_date if file.upload_date else 'N/A' }}</span>
                            {% if current_user.role == 'admin' and file.uploader_name %}
                                <span class="ms-3"><i class="bi bi-person"></i> {{ file.uploader_name }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="file-status">
                        {% if file.is_indexed %}
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle"></i> İndekslenmiş
                            </span>
                        {% else %}
                            <span class="badge bg-warning">
                                <i class="bi bi-clock"></i> Bekliyor
                            </span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="file-actions">
                    {% if not file.is_indexed %}
                    <form method="POST" action="{{ url_for('index_file', document_id=file.id) }}" style="display: inline;">
                        <button type="submit" class="btn btn-unified btn-sm" title="İndeksle">
                            <i class="bi bi-gear"></i> İndeksle
                        </button>
                    </form>
                    {% endif %}
                    <a href="{{ url_for('serve_file') }}?path={{ file.file_path | urlencode }}" 
                       class="btn btn-outline-unified btn-sm" title="İndir">
                        <i class="bi bi-download"></i> İndir
                    </a>
                    {% if current_user.role == 'admin' or file.uploaded_by == current_user.id %}
                    <form method="POST" action="{{ url_for('delete_file', document_id=file.id) }}" 
                          style="display: inline;" 
                          onsubmit="return confirm('Bu dosyayı silmek istediğinizden emin misiniz?')">
                        <button type="submit" class="btn btn-danger btn-sm" title="Sil">
                            <i class="bi bi-trash"></i> Sil
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block custom_scripts %}
<script>
// Drag and Drop functionality with unified design
const dragDropArea = document.getElementById('dragDropArea');
const fileInput = document.getElementById('fileInput');
const uploadProgress = document.getElementById('uploadProgress');
const progressList = document.getElementById('progressList');

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dragDropArea.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
});

// Highlight drop area when item is dragged over it
['dragenter', 'dragover'].forEach(eventName => {
    dragDropArea.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dragDropArea.addEventListener(eventName, unhighlight, false);
});

// Handle dropped files
dragDropArea.addEventListener('drop', handleDrop, false);
fileInput.addEventListener('change', handleFileSelect, false);

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function highlight() {
    dragDropArea.classList.add('dragover');
}

function unhighlight() {
    dragDropArea.classList.remove('dragover');
}

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
}

function handleFileSelect(e) {
    const files = e.target.files;
    handleFiles(files);
}

function handleFiles(files) {
    // Show upload progress section
    uploadProgress.style.display = 'block';
    progressList.innerHTML = '';

    // Validate files
    const validFiles = [];
    const maxSize = 50 * 1024 * 1024; // 50MB
    const allowedTypes = ['.pdf', '.docx', '.xlsx', '.pptx', '.txt'];

    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const extension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!allowedTypes.includes(extension)) {
            showToast(`Dosya türü desteklenmiyor: ${file.name}`, 'error');
            continue;
        }
        
        if (file.size > maxSize) {
            showToast(`Dosya çok büyük (>50MB): ${file.name}`, 'error');
            continue;
        }
        
        validFiles.push(file);
    }

    if (validFiles.length === 0) {
        uploadProgress.style.display = 'none';
        return;
    }

    const formData = new FormData();
    validFiles.forEach(file => {
        formData.append('files', file);
    });

    // Create progress indicators
    validFiles.forEach(file => {
        const progressDiv = document.createElement('div');
        progressDiv.className = 'progress-item';
        progressDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center w-100">
                <div class="file-info">
                    <strong>${file.name}</strong>
                    <small class="text-muted d-block">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                </div>
                <div class="progress-status">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                </div>
            </div>
            <div class="progress-unified mt-2">
                <div class="progress-bar-unified" style="width: 0%"></div>
            </div>
        `;
        progressList.appendChild(progressDiv);
    });

    // Upload files
    fetch('/upload_file', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Update progress indicators
        const progressItems = progressList.querySelectorAll('.progress-item');
        progressItems.forEach(item => {
            const progressBar = item.querySelector('.progress-bar-unified');
            const spinner = item.querySelector('.spinner-border');
            
            progressBar.style.width = '100%';
            spinner.remove();
            
            if (data.success) {
                item.querySelector('.progress-status').innerHTML = 
                    '<i class="bi bi-check-circle-fill text-success"></i>';
            } else {
                item.querySelector('.progress-status').innerHTML = 
                    '<i class="bi bi-x-circle-fill text-danger"></i>';
            }
        });

        if (data.success) {
            showToast(`${validFiles.length} dosya başarıyla yüklendi`, 'success');
            
            setTimeout(() => {
                location.reload(); // Refresh to show uploaded files
            }, 1500);
        } else {
            showToast('Yükleme hatası: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        showToast('Yükleme sırasında hata oluştu', 'error');
        
        // Update progress indicators to show error
        const progressItems = progressList.querySelectorAll('.progress-item');
        progressItems.forEach(item => {
            const spinner = item.querySelector('.spinner-border');
            if (spinner) {
                spinner.remove();
                item.querySelector('.progress-status').innerHTML = 
                    '<i class="bi bi-x-circle-fill text-danger"></i>';
            }
        });
    });
}

// File size formatter
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add file drag visual feedback
    document.addEventListener('dragover', function(e) {
        e.preventDefault();
        document.body.classList.add('drag-active');
    });
    
    document.addEventListener('dragleave', function(e) {
        if (e.clientX === 0 && e.clientY === 0) {
            document.body.classList.remove('drag-active');
        }
    });
    
    document.addEventListener('drop', function(e) {
        e.preventDefault();
        document.body.classList.remove('drag-active');
    });
});
</script>
{% endblock %}